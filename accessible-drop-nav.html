<style>
	
	.nav.drop :focus {
		
		outline: solid 2px blue;
		outline-offset: -.4em;
    
	}
	
	.nav.drop ul ul {
		
		padding: 0;
		position: absolute;
		left: 0;
		top: 3em;
		background: #fff;

	}
	
	.nav.drop ul ul ul {
		
		margin-left: 100%;
		top: 0;

	}
	
	.nav.drop li {
		
		display: inline-block;
		vertical-align: top;
		margin: 0;
		padding: 0;
		padding-right: 2em;
		
	}
	
	.nav.drop li > a {
		
		padding: 1em;
		display: block;

	}
	
	.nav.drop li {
		
/* 		padding-left: 0; */
		z-index: 0;
		position: relative;
		white-space: nowrap;
		
	}

	.nav.drop li li {
		
		display: block;

	}
	
	.nav.drop input:not(:checked) ~ ul {
		
		display: none;

	}
	
	.nav.drop input {
		
		-webkit-appearance: none;
		-moz-appearance: none;
		display: block;
		position: absolute;
/* 		background: red; */
		margin: 0;
		top: 0;
		right: 0;
		bottom: 0;
		left: 0;
		width: 100%;
		background: url(images/select.png) right center no-repeat;
		background-position-x: calc(100% - 1em);
					
	}

	.nav.drop li li input {

		background-image: url(images/select-right.png);

	}

	.nav.drop a[href] ~ input {

		z-index: -1;

	}

</style>

<h1>Keyboard-accessible drop-down navigation</h1>

<a tabindex="0">Focusable before</a>

<div class="nav drop">
	
	<ul>
		
		<li>
		
				<a>One</a>
				
				<input type="radio" name="level-0">
				
				<ul>
					
					<li>
					
							<a>One 1</a>
						
							<input type="radio" name="level-0-1">

							<ul>
								
								<li>
								
									<a href=#>One 1 1</a>
								
								</li>
								
								<li>
								
									<a href=#>One 1 2</a>
								
								</li>
								
							</ul>
						
					</li>
					
					<li>
						
							<a>One 2</a>
						
							<input type="radio" name="level-0-1">
	
							<ul>
								
								<li>
								
									<a href=# tabindex="0">One 2 1</a>
								
								</li>
								
								<li>
								
									<a href=#>One 2 2</a>
								
								</li>
								
							</ul>
						
					</li>
					
				</ul>
				
		</li>
		
		<li>
		
			<a href=# tabindex="-1">Two</a>
			
			<input type="radio" name="level-0">
			
			<ul> 
				
				<li>
				
					<a href=#>Two 1</a>
				
				</li>
				
				<li>
				
					<a href=#>Two 2</a>
				
				</li>
				
			</ul>
		
		</li>
		
	</ul>

</div>

<a tabindex="0">Focusable after</a>

<script>

var active_item = null;	

	document.querySelectorAll('.nav.drop > ul > li > input').forEach ( function (el) { // Disable standard keyboard behaviour on inputs
		
		el.onkeyup = el.onkeydown = el.onkeypress = function(e) {
			
			if (e.key === 'ArrowDown') {
			
				e.preventDefault();
			
			}
			
		};
		
	});
	
	function focusItem(e) {
			
		var el = e.target;	
		if (el.checked && el.getAttribute('data-checked')) {

			el.removeAttribute('data-checked');
			el.checked = false;
			
			el.parentNode.querySelector('ul').querySelectorAll('input').forEach( function (el) {
				
				el.checked = false;
				el.removeAttribute('data-checked');
				
			});
			
		} else {
			
			// Clear data-attribute from all other inputs
			
			document.querySelectorAll('input[name=' + el.name + ']').forEach( function (el) {
				
				el.checked = false;
				el.removeAttribute('data-checked');
				
			});
			
			
		}
		
			el.checked = true;
			el.setAttribute('data-checked', 'true');
			el.focus();
		
		
		return false;

	}

	function blurEvent(e) {

/*
		if (!document.querySelector('.nav.drop :focus')) {
		console.log('blur');
			
			document.querySelectorAll('.nav.drop [data-checked]').forEach( function (el) {
				
				el.checked = false;
				el.removeAttribute('data-checked');
				
			});
			
		}
*/
		
	}

	document.querySelectorAll('.nav.drop input').forEach ( function (el) {
		
		el.addEventListener('click', focusItem);
		el.addEventListener('focus', function(e) {

			if (!e.target.getAttribute('data-checked')) {
				
				focusItem(e);
				
			}
			
		});
		
		el.addEventListener('blur', blurEvent);
		
		el.addEventListener('keyup', function (e) {

			if (e.key === 'Enter') {
	
				el.previousElementSibling.click();
			
			}
			
		});
		
		el.addEventListener('keydown', function (e) {

			if (e.key === 'ArrowDown') { // Focus on sub nav
				
				document.querySelectorAll('.nav.drop input').forEach ( function (el) {
					
					el.removeEventListener('blur', blurEvent);
					
				});
	
				if (e.target.parentNode.querySelector('ul').querySelector('input')) {
				console.log(e.target.parentNode.querySelector('ul'));
					
					e.stopPropagation();
					e.target.parentNode.querySelector('ul').querySelector('input').focus();
				

				} else { // Focus on any child ul with a[href]
					
					
				}

				document.querySelectorAll('.nav.drop input').forEach ( function (el) {
					
					el.addEventListener('blur', blurEvent);
					
				});

// 				e.target.parentNode.querySelector('ul').querySelector('input').focus();
				
			}
			
		});
		
	});
	
	document.querySelectorAll('.nav.drop input, .nav.drop a[href]').forEach ( function (el) {
		
/*
		if (el.nextElementSibling.type === 'radio') {
			
			el.setAttribute('tabindex', '-1');
			
		}
*/
		
		el.addEventListener('keyup', function (e) {

			if (e.key === 'Escape') {
				
				e.target.blur();
				document.querySelectorAll('.nav.drop input[data-checked]').forEach ( function (el) {
				
					el.checked = false;
					el.removeAttribute('data-checked');

				});
				
			}

		});

	});

	document.querySelector('.nav.drop li li:first-child > input').addEventListener('keydown', function (e) {
		
		if (e.key === 'ArrowUp') {

			e.stopPropagation();
			e.preventDefault();
			e.target.parentNode.parentNode.parentNode.querySelector('input').focus();
			return false;
		
		}
		
	});
	
	// When focused on a top-level item, bottom arrow key should move focus to its first child item
	
</script>

